<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chat Room</title>
    <style>
        body { font-family: sans-serif; background: #2c2f33; color: white; display: flex; flex-direction: column; height: 100vh; margin: 0; }
        #chat-log { flex-grow: 1; padding: 1rem; overflow-y: auto; border-bottom: 1px solid #23272a; }
        #chat-controls { display: flex; padding: 1rem; background: #23272a; }
        #chat-message-input { flex-grow: 1; padding: 10px; border: 1px solid #40444b; background: #40444b; color: white; border-radius: 5px; }
        #chat-message-submit { padding: 10px 15px; margin-left: 10px; background: #7289da; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .message { margin-bottom: 0.5rem; }
        .message .author { font-weight: bold; color: #7289da; }
    </style>
</head>
<body>
    <div id="chat-log"></div>
    <div id="chat-controls">
        <input id="chat-message-input" type="text" placeholder="Type a message...">
        <button id="chat-message-submit">Send</button>
    </div>

    <script>
        const chatLog = document.getElementById('chat-log');
        const messageInput = document.getElementById('chat-message-input');
        const messageSubmit = document.getElementById('chat-message-submit');
        
        // Get the room ID from the URL (e.g., ?room_id=42)
        const room_id = new URLSearchParams(window.location.search).get('room_id');
        const accessToken = localStorage.getItem('accessToken');

        if (!accessToken || !room_id) {
            window.location.href = 'login.html';
        }

        // --- CONNECTION TO BACKEND WEBSOCKET ---
        // This creates the live connection to your Django Channels consumer.
        const chatSocket = new WebSocket(
            'ws://' + window.location.host + '/ws/chat/' + room_id + '/'
        );

        // This function is called whenever a message is received from the backend.
        chatSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            messageDiv.innerHTML = `<span class="author">${data.author}:</span> ${data.message}`;
            chatLog.appendChild(messageDiv);
            chatLog.scrollTop = chatLog.scrollHeight; // Auto-scroll to bottom
        };

        chatSocket.onclose = function(e) {
            console.error('Chat socket closed unexpectedly');
        };

        // Function to send a message
        function sendMessage() {
            const message = messageInput.value;
            if (message.trim() === '') return;
            
            // Send the message to the WebSocket consumer as a JSON string.
            chatSocket.send(JSON.stringify({
                'message': message
            }));
            
            messageInput.value = ''; // Clear the input field
        }
        
        messageSubmit.addEventListener('click', sendMessage);
        messageInput.addEventListener('keyup', function(e) {
            if (e.keyCode === 13) {  // "Enter" key
                sendMessage();
            }
        });

        // --- CONNECTION TO BACKEND API (for message history) ---
        // Fetch past messages when the page loads.
        async function fetchHistory() {
             const response = await fetch(`http://127.0.0.1:8000/chat/${room_id}/messages/`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${accessToken}`
                }
            });
            const history = await response.json();
            history.forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message';
                messageDiv.innerHTML = `<span class="author">${msg.author_username}:</span> ${msg.content}`;
                chatLog.appendChild(messageDiv);
            });
            chatLog.scrollTop = chatLog.scrollHeight; // Auto-scroll
        }

        fetchHistory();
    </script>
</body>
</html>